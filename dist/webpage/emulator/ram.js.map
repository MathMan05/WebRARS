{"version":3,"sources":["../../../src/webpage/emulator/ram.ts"],"sourcesContent":["import {I18n} from \"../i18n.js\";\nimport {runTimeError} from \"./emulator.js\";\nclass RamStore {\n\tdata: Uint32Array;\n\ttext: Uint32Array;\n\tlengths: [number, number];\n\tconstructor(ram: Ram) {\n\t\tthis.data = this.trimNonZero(ram.data, ram.lengths[0]);\n\t\tthis.text = this.trimNonZero(ram.text, ram.lengths[1]);\n\t\tthis.lengths = [...ram.lengths];\n\t}\n\ttrimNonZero(view: DataView, length: number) {\n\t\tlet last = Math.ceil(length / 4);\n\t\tconst arr = new Uint32Array(view.buffer);\n\t\treturn new Uint32Array(arr.slice(0, last + 1).buffer);\n\t}\n\ttoRam() {\n\t\tconst data = new Uint32Array(new ArrayBuffer(1 << 22));\n\t\tfor (const thing in this.data) {\n\t\t\tdata[thing] = this.data[thing];\n\t\t}\n\t\tconst text = new Uint32Array(new ArrayBuffer(1 << 22));\n\t\tfor (const thing in this.text) {\n\t\t\ttext[thing] = this.text[thing];\n\t\t}\n\t\treturn new Ram(new DataView(data.buffer), new DataView(text.buffer), [...this.lengths]);\n\t}\n}\nclass Ram {\n\tdata: DataView;\n\ttext: DataView;\n\tlengths: [number, number];\n\tconstructor(data: DataView, text: DataView, lengths: [number, number]) {\n\t\tthis.data = data;\n\t\tthis.text = text;\n\t\tthis.lengths = lengths;\n\t\tdata.getInt32;\n\t}\n\treadFrom(val: number | bigint, read = true): [\"data\" | \"text\", number] {\n\t\tval = Number(val);\n\t\tif (val >= 0x10010000 && val < 0x10010000 + this.data.byteLength) {\n\t\t\tif (!read && val - 0x10010000 > this.lengths[0]) {\n\t\t\t\tthis.lengths[0] = val - 0x10010000;\n\t\t\t}\n\t\t\treturn [\"data\", val - 0x10010000];\n\t\t} else if (val >= 0x00400000 && val < 0x00400000 + this.text.byteLength) {\n\t\t\tif (!read && val - 0x00400000 > this.lengths[1]) {\n\t\t\t\tthis.lengths[1] = val - 0x00400000;\n\t\t\t}\n\t\t\treturn [\"text\", val - 0x00400000];\n\t\t} else {\n\t\t\tif (read) {\n\t\t\t\tthrow new runTimeError(I18n.runTimeErrors.outOfBoundsRead(val.toString(16)));\n\t\t\t} else {\n\t\t\t\tthrow new runTimeError(I18n.runTimeErrors.outOfBoundsWrite(val.toString(16)));\n\t\t\t}\n\t\t}\n\t}\n\tcompact() {\n\t\treturn new RamStore(this);\n\t}\n\tsetFloat64(val: number | bigint, value: number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setFloat64(vals[1], value, true);\n\t}\n\tgetFloat64(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getFloat64(vals[1], true);\n\t}\n\tsetBigInt64(val: number | bigint, value: bigint | number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setBigInt64(vals[1], BigInt(value), true);\n\t}\n\tgetBigInt64(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getBigInt64(vals[1], true);\n\t}\n\tgetBigUint64(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getBigUint64(vals[1], true);\n\t}\n\tsetFloat32(val: number | bigint, value: number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setFloat32(vals[1], value, true);\n\t}\n\tgetFloat32(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getFloat32(vals[1], true);\n\t}\n\tsetInt32(val: number | bigint, value: bigint | number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setInt32(vals[1], Number(value), true);\n\t}\n\tgetInt32(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getInt32(vals[1], true);\n\t}\n\tgetUint32(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getUint32(vals[1], true);\n\t}\n\tsetInt16(val: number | bigint, value: bigint | number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setInt16(vals[1], Number(value), true);\n\t}\n\tgetInt16(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getInt16(vals[1], true);\n\t}\n\tgetUint16(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getUint16(vals[1], true);\n\t}\n\tsetInt8(val: number | bigint, value: bigint | number) {\n\t\tconst vals = this.readFrom(val);\n\t\tthis[vals[0]].setInt8(vals[1], Number(value));\n\t}\n\tgetInt8(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getInt8(vals[1]);\n\t}\n\tgetUint8(val: number | bigint) {\n\t\tconst vals = this.readFrom(val);\n\t\treturn this[vals[0]].getUint8(vals[1]);\n\t}\n}\n\nexport {Ram, RamStore};\n"],"names":["I18n","runTimeError","RamStore","data","text","lengths","constructor","ram","trimNonZero","view","length","last","Math","ceil","arr","Uint32Array","buffer","slice","toRam","ArrayBuffer","thing","Ram","DataView","getInt32","readFrom","val","read","Number","byteLength","runTimeErrors","outOfBoundsRead","toString","outOfBoundsWrite","compact","setFloat64","value","vals","getFloat64","setBigInt64","BigInt","getBigInt64","getBigUint64","setFloat32","getFloat32","setInt32","getUint32","setInt16","getInt16","getUint16","setInt8","getInt8","getUint8"],"mappings":"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"}